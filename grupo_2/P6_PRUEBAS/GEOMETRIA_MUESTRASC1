// Definir las colecciones y variables necesarias
//
var version = '4'
var year = 2023  
var list_geom = ee.FeatureCollection([Area_urbana, minera, Carretera_asfaltada, Trocha]).flatten()

var area_trabajo = ee.FeatureCollection("projects/ee-eturpocayo/assets/sernanp/AUXILIAR_DATA/limite_anp_y_za_v2")
var area_trabajo_raster = ee.Image("projects/ee-eturpocayo/assets/sernanp/AUXILIAR_DATA/limite_anp_y_za_v2_raster")
// Map.addLayer(area_trabajo,{},'area_trabajo')


var RGB = {bands: ['R', 'N', 'B'], gain: [0.2, 0.06, 0.2]}; // ANDES
// var RGB = {bands: ['R', 'G', 'B'], min:630, max:2950}; //COSTA

// Geometrias_colectadas_assets
  var folder = 'projects/ee-anp-lineabase/assets/AUXILIAR-DATA/geometry';
  var list = ee.List([]);
  
  function list_folder_to_featColl(e) {
    var path = e.id;
    var fc = ee.FeatureCollection(path)
              // .aggregate_sum('system:asset_size')
              // .divide(ee.Number(1024).pow(4))
    return fc; 
  }
  
  // Function to recursively concatenate asset lists from multiple pages
  function listAssetsRecursive(folder, pageToken) {
    var options = {};
    if (pageToken !== undefined) {
      options.pageToken = pageToken;
    }
  
    var result = ee.data.listAssets(folder, options);
    var assets = result['assets'];
    list = list.cat(assets.map(list_folder_to_featColl));
  
    if (result.nextPageToken !== null) {
      // Call the function recursively for the next page
      listAssetsRecursive(folder, result.nextPageToken);
    }
  }
  
  // Start listing assets
  listAssetsRecursive(folder);
  
  // Print the final concatenated asset list
  // print('Final Asset List:', list);
  
  var geometry_draw = ee.FeatureCollection(list).flatten()
                        .filter(ee.Filter.neq('name', 'Bosque_plantado'));
  
  // print(geometry_draw.size())

  // Map.addLayer(geometry_draw,{},'DRAW1')


// mosaico Planet y Sentinel para um determinado mês e ano
function getPlanetMosaic(year, month) {
  var startDate = ee.Date.fromYMD(year, month, 1);
  var endDate = startDate.advance(1, 'month');
  var collection = ee.ImageCollection('projects/ee-anp-lineabase/assets/mosaics')
    // .filterBounds(randomPoints)
    .filter(ee.Filter.eq('month', month))
    // .filterDate(startDate, endDate)
    .mosaic();
  return collection;
};

function getSentinel2(year, month) {
  var startDate = ee.Date.fromYMD(year, month, 1);
  var endDate = startDate.advance(1, 'month');
  var collection = ee.ImageCollection('COPERNICUS/S2_SR')
    .filterDate(startDate, endDate)
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 70))
    .median();
  return collection;
}

// Function for stretch visualization
function visual(image, geometry, bands, scale, stretch, name, show){
  typeof scale == 'undefined' ? scale = 100 : null;
  typeof stretch == 'undefined' ? stretch = [2, 98] : null;
  typeof name == 'undefined' ? name = 'Layer ' + Map.layers().length() : null;
  typeof show == 'undefined' ? show = true : null;
  
  var minMax = image.select(bands).reduceRegion({
    reducer: ee.Reducer.percentile(stretch),
    scale: scale,
    geometry: geometry,
    bestEffort: true
  });
  
  var scaled = ee.Image(bands.map(function(band){
    var imageBand = image.select(band);
    var min = ee.Number(minMax.get(band + '_p' + Math.round(stretch[0])));
    var max = ee.Number(minMax.get(band + '_p' + Math.round(stretch[1])));
    
    return imageBand.unitScale(min, max).rename(band);
  }));
  Map.addLayer(scaled, { min: 0, max: 1, bands: bands}, name, show);
}

  
for(var monthI=1; monthI<=12; monthI++ ){
  // // var monthI = 6
  // var area_trabajo = ee.FeatureCollection("projects/ee-eturpocayo/assets/sernanp/AUXILIAR_DATA/limite_anp_y_za_v2")
  //                       .filter(ee.Filter.eq('Codigo_uni', region));
  
  // var area_trabajo_raster = ee.Image("projects/ee-eturpocayo/assets/sernanp/AUXILIAR_DATA/limite_anp_y_za_v2_raster").eq(region);

  // Combinacion de bandas para color natural
  // var RGB = {bands: ["R", "G", "B"], min: 0, max: 1500};
  
  // Se calcula la mediana de los pixeles dentro de la imagen y se recorta segun la forma del ANP
  var Planet_mosaic = getPlanetMosaic(year, monthI);
  var S2_mosaic = getSentinel2(year, monthI);
  
  var NICFIAmerica_CLIP = Planet_mosaic//.clip(area_trabajo);
  
  // Calcular NDVI y añadirlo como banda
  var ndvi = NICFIAmerica_CLIP.normalizedDifference(['N', 'R']).rename('NDVI');
  var imagenConNDVI = NICFIAmerica_CLIP.addBands(ndvi);
  
  // Mostrar en el visor del mapa la imagen solicitada
  Map.addLayer(NICFIAmerica_CLIP, RGB, 'Planet-' + year + '-Mes' + monthI, false);
  // visual(Planet_mosaic, area_trabajo.geometry().bounds(), ['R', 'N', 'B'], 5, [2, 98],'Planet-' + year + '-Mes' + monthI +'s', false);
  // Map.addLayer(S2_mosaic, 
  // {bands: ['B11', 'B8', 'B4'], min: 1000, max: 4500, gamma: 1.0},
  // 'Sentinel-' + year + '-Mes' + monthI, false);
  //   // Map.addLayer(trainning,{},'trainning')
  
 
 

  // Exportar la imagen resultante
  // Export.image.toDrive({
  //   image: imagenClasificada,
  //   description: 'imagenClasificada',
  //   scale: 5,  // Ajusta esta escala según la resolución espacial de tus imágenes
  //   region: area_trabajo,
  //   maxPixels: 1e13,
  //   fileFormat: 'GeoTIFF'
  // });
  
  
  // // Exportar imagen color natural
  // Export.image.toDrive({
  //   image: NICFIAmerica_CLIP.select("R","G","B"),
  //   description: "Imagen_Planet", 
  //   scale: 4.7,
  //   maxPixels: 1e13,
  //   region: LimiteSelect
  // });

}
 Export.table.toAsset({
   collection:list_geom, 
   description: 'Urban_mining-2023-draw-' + version,
   assetId: 'projects/ee-anp-lineabase/assets/AUXILIAR-DATA/geometry/' + 'Urban_mining-2023-draw-' + version, 
   }
   )
   
var Mapbiomas = ee.Image('projects/mapbiomas-public/assets/peru/collection2/mapbiomas_peru_collection2_integration_v1')
                  .select('classification_2021');

 
var WorldCover = ee.ImageCollection('ESA/WorldCover/v200').first();

var urba_min = Mapbiomas.eq(24).or(Mapbiomas.eq(30)).or(WorldCover.eq(50)).selfMask()
urba_min = urba_min.where(Mapbiomas.eq(30),2)

Map.addLayer(urba_min,{min:1, max:2, palette:['red','#ff00f5']},'referencia')

// Mostrar Limite de ANP seleccionado
  var styling = {color: 'cyan', fillColor: '00000000'};
  Map.addLayer(area_trabajo.style(styling),{},'Limite_ANP', true);
  Map.addLayer(geometry_draw,{},'DRAW1')